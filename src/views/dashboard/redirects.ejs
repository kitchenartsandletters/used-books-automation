<%- include('../layouts/dashboard-header', { title: title }) %>

<div class="dashboard-content">
  <div class="container-fluid">
    <!-- Dashboard header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">Redirects Management</h1>
      
      <div class="actions">
        <button type="button" class="btn btn-outline-primary mr-2" data-toggle="modal" data-target="#createRedirectModal">
          <i class="fas fa-plus"></i> Create Redirect
        </button>
        <form action="/dashboard/scan" method="post" class="d-inline">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Run Full Scan
          </button>
        </form>
      </div>
    </div>
    
    <!-- Flash messages -->
    <% if (locals.messages && messages.success) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= messages.success %>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    <% } %>
    
    <% if (locals.messages && messages.error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= messages.error %>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    <% } %>
    
    <!-- Redirects Table -->
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Active Redirects (<%= redirects.length %>)</h6>
        
        <div class="input-group" style="width: 300px;">
          <input type="text" id="redirectSearch" class="form-control" placeholder="Search redirects...">
          <div class="input-group-append">
            <button class="btn btn-primary" type="button" id="searchButton">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <% if (redirects && redirects.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-bordered dataTable" id="redirectsTable" width="100%" cellspacing="0">
              <thead>
                <tr>
                  <th>Path (From)</th>
                  <th>Target (To)</th>
                  <th>Type</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% redirects.forEach(redirect => { %>
                  <tr>
                    <td>
                      <small><code><%= redirect.path %></code></small>
                    </td>
                    <td>
                      <small><code><%= redirect.target %></code></small>
                    </td>
                    <td>
                      <span class="badge badge-<%= redirect.redirect_type === '301' ? 'dark' : 'info' %>">
                        <%= redirect.redirect_type %>
                      </span>
                    </td>
                    <td>
                      <!-- Test redirect -->
                      <a 
                        href="https://<%= process.env.SHOP_URL %><%= redirect.path %>"
                        class="btn btn-sm btn-info"
                        target="_blank"
                        data-toggle="tooltip"
                        title="Test Redirect"
                      >
                        <i class="fas fa-external-link-alt"></i>
                      </a>
                      
                      <!-- Edit redirect -->
                      <button 
                        type="button" 
                        class="btn btn-sm btn-primary"
                        data-toggle="modal" 
                        data-target="#editRedirectModal"
                        data-id="<%= redirect.id %>"
                        data-path="<%= redirect.path %>"
                        data-target="<%= redirect.target %>"
                        data-type="<%= redirect.redirect_type %>"
                      >
                        <i class="fas fa-edit"></i>
                      </button>
                      
                      <!-- Delete redirect -->
                      <form 
                        action="/dashboard/redirects/<%= redirect.id %>/delete" 
                        method="post" 
                        class="d-inline"
                        data-confirm="Are you sure you want to delete this redirect?"
                      >
                        <button 
                          type="submit" 
                          class="btn btn-sm btn-danger"
                          data-toggle="tooltip"
                          title="Delete Redirect"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="text-center py-5">
            <i class="fas fa-exchange-alt fa-4x mb-3 text-gray-300"></i>
            <p class="lead text-gray-500">No redirects found.</p>
            <button type="button" class="btn btn-primary mt-3" data-toggle="modal" data-target="#createRedirectModal">
              Create Your First Redirect
            </button>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Create Redirect Modal -->
<div class="modal fade" id="createRedirectModal" tabindex="-1" role="dialog" aria-labelledby="createRedirectModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createRedirectModalLabel">Create New Redirect</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="/dashboard/redirects/create" method="post">
        <div class="modal-body">
          <div class="form-group">
            <label for="path">Path (From)</label>
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text">/products/</span>
              </div>
              <input type="text" class="form-control" id="path" name="path" placeholder="book-title-used-condition" required>
            </div>
            <small class="form-text text-muted">The path that users will be redirected from.</small>
          </div>
          
          <div class="form-group">
            <label for="target">Target (To)</label>
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text">/products/</span>
              </div>
              <input type="text" class="form-control" id="target" name="target" placeholder="book-title" required>
            </div>
            <small class="form-text text-muted">The path that users will be redirected to.</small>
          </div>
          
          <div class="form-group">
            <label for="redirectType">Redirect Type</label>
            <select class="form-control" id="redirectType" name="redirectType">
              <option value="302" selected>302 (Temporary)</option>
              <option value="301">301 (Permanent)</option>
            </select>
            <small class="form-text text-muted">302 is recommended for used books.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Redirect</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Redirect Modal -->
<div class="modal fade" id="editRedirectModal" tabindex="-1" role="dialog" aria-labelledby="editRedirectModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editRedirectModalLabel">Edit Redirect</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="/dashboard/redirects/update" method="post">
        <input type="hidden" id="editRedirectId" name="id">
        <div class="modal-body">
          <div class="form-group">
            <label for="editPath">Path (From)</label>
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text">/products/</span>
              </div>
              <input type="text" class="form-control" id="editPath" name="path" placeholder="book-title-used-condition" required>
            </div>
            <small class="form-text text-muted">The path that users will be redirected from.</small>
          </div>
          
          <div class="form-group">
            <label for="editTarget">Target (To)</label>
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text">/products/</span>
              </div>
              <input type="text" class="form-control" id="editTarget" name="target" placeholder="book-title" required>
            </div>
            <small class="form-text text-muted">The path that users will be redirected to.</small>
          </div>
          
          <div class="form-group">
            <label for="editRedirectType">Redirect Type</label>
            <select class="form-control" id="editRedirectType" name="redirectType">
              <option value="302">302 (Temporary)</option>
              <option value="301">301 (Permanent)</option>
            </select>
            <small class="form-text text-muted">302 is recommended for used books.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Redirect</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Fill edit modal with redirect data
  $('#editRedirectModal').on('show.bs.modal', function (event) {
    const button = $(event.relatedTarget);
    const id = button.data('id');
    const path = button.data('path').replace('/products/', '');
    const target = button.data('target').replace('/products/', '');
    const type = button.data('type');
    
    const modal = $(this);
    modal.find('#editRedirectId').val(id);
    modal.find('#editPath').val(path);
    modal.find('#editTarget').val(target);
    modal.find('#editRedirectType').val(type);
  });
  
  // Search redirects table
  $(document).ready(function() {
    $('#redirectSearch').on('keyup', function() {
      const value = $(this).val().toLowerCase();
      $('#redirectsTable tbody tr').filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
      });
    });
  });
</script>

<%- include('../layouts/dashboard-footer') %>