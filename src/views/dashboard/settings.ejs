<%- include('../layouts/dashboard-header', { title: title }) %>

<div class="dashboard-content">
  <div class="container-fluid">
    <!-- Dashboard header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">Settings</h1>
    </div>
    
    <!-- Flash messages -->
    <% if (locals.messages && messages.success) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= messages.success %>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    <% } %>
    
    <% if (locals.messages && messages.error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= messages.error %>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    <% } %>
    
    <div class="row">
      <!-- System Settings -->
      <div class="col-lg-6">
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">System Configuration</h6>
          </div>
          <div class="card-body">
            <div class="mb-4">
              <h5 class="font-weight-bold">Shopify Connection</h5>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>Webhooks Registered</span>
                <span>
                  <% if (config.webhooksRegistered) { %>
                    <span class="badge badge-success">Yes</span>
                  <% } else { %>
                    <span class="badge badge-danger">No</span>
                    <a href="/dashboard/webhooks/register" class="btn btn-sm btn-outline-primary ml-2">
                      Register
                    </a>
                  <% } %>
                </span>
              </div>
            </div>
            
            <div class="mb-4">
              <h5 class="font-weight-bold">Email Notifications</h5>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>Status</span>
                <span>
                  <% if (config.emailEnabled) { %>
                    <span class="badge badge-success">Enabled</span>
                  <% } else { %>
                    <span class="badge badge-danger">Disabled</span>
                  <% } %>
                </span>
              </div>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>From Address</span>
                <span><%= config.emailFrom %></span>
              </div>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>To Address</span>
                <span><%= config.emailTo %></span>
              </div>
              <div class="mt-3">
                <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#testEmailModal">
                  <i class="fas fa-envelope"></i> Send Test Email
                </button>
              </div>
            </div>
            
            <div class="mb-4">
              <h5 class="font-weight-bold">Scheduled Tasks</h5>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>Auto Scan (every 30 minutes)</span>
                <span>
                  <% if (global.cronJobsActive) { %>
                    <span class="badge badge-success">Active</span>
                  <% } else { %>
                    <span class="badge badge-danger">Inactive</span>
                  <% } %>
                </span>
              </div>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>Daily Backup (1:00 AM)</span>
                <span>
                  <% if (global.cronJobsActive) { %>
                    <span class="badge badge-success">Active</span>
                  <% } else { %>
                    <span class="badge badge-danger">Inactive</span>
                  <% } %>
                </span>
              </div>
              <div class="mt-3">
                <% if (global.cronJobsActive) { %>
                  <form action="/dashboard/cron/stop" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-danger">
                      <i class="fas fa-stop-circle"></i> Stop Scheduled Tasks
                    </button>
                  </form>
                <% } else { %>
                  <form action="/dashboard/cron/start" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="fas fa-play-circle"></i> Start Scheduled Tasks
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Backup Management -->
      <div class="col-lg-6">
        <div class="card shadow mb-4">
          <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Backup Management</h6>
            <form action="/dashboard/backups/create" method="post" class="d-inline">
              <button type="submit" class="btn btn-sm btn-primary">
                <i class="fas fa-save"></i> Create Backup
              </button>
            </form>
          </div>
          <div class="card-body">
            <% if (backups && backups.length > 0) { %>
              <div class="table-responsive">
                <table class="table table-bordered" id="backupsTable" width="100%" cellspacing="0">
                  <thead>
                    <tr>
                      <th>Filename</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% backups.forEach(backup => { %>
                      <tr>
                        <td><%= backup.filename %></td>
                        <td><%= new Date(backup.timestamp).toLocaleString() %></td>
                        <td>
                          <form 
                            action="/dashboard/backups/restore" 
                            method="post" 
                            class="d-inline"
                            data-confirm="Are you sure you want to restore this backup? This will overwrite any current redirects."
                          >
                            <input type="hidden" name="filename" value="<%= backup.filename %>">
                            <button type="submit" class="btn btn-sm btn-warning">
                              <i class="fas fa-undo"></i>
                            </button>
                          </form>
                          
                          <form 
                            action="/dashboard/backups/delete" 
                            method="post" 
                            class="d-inline"
                            data-confirm="Are you sure you want to delete this backup?"
                          >
                            <input type="hidden" name="filename" value="<%= backup.filename %>">
                            <button type="submit" class="btn btn-sm btn-danger">
                              <i class="fas fa-trash"></i>
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="text-center py-5">
                <i class="fas fa-save fa-4x mb-3 text-gray-300"></i>
                <p class="lead text-gray-500">No backups found.</p>
                <form action="/dashboard/backups/create" method="post">
                  <button type="submit" class="btn btn-primary mt-3">
                    Create Your First Backup
                  </button>
                </form>
              </div>
            <% } %>
          </div>
        </div>
        
        <!-- Server Info -->
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Server Information</h6>
          </div>
          <div class="card-body">
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <span>Environment</span>
              <span class="badge badge-info"><%= process.env.NODE_ENV || 'development' %></span>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <span>Node.js Version</span>
              <span class="badge badge-info"><%= process.version %></span>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <span>Uptime</span>
              <span class="badge badge-info">
                <%= Math.floor(process.uptime() / 86400) %> days, 
                <%= Math.floor((process.uptime() % 86400) / 3600) %> hours, 
                <%= Math.floor((process.uptime() % 3600) / 60) %> minutes
              </span>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <span>Memory Usage</span>
              <span class="badge badge-info">
                <%= Math.round(process.memoryUsage().rss / 1024 / 1024) %> MB
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Test Email Modal -->
<div class="modal fade" id="testEmailModal" tabindex="-1" role="dialog" aria-labelledby="testEmailModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="testEmailModalLabel">Send Test Email</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="/dashboard/settings/test-email" method="post">
        <div class="modal-body">
          <div class="form-group">
            <label for="recipient">Recipient Email</label>
            <input type="email" class="form-control" id="recipient" name="recipient" value="<%= config.emailTo %>" required>
          </div>
          <div class="form-group">
            <label for="subject">Subject</label>
            <input type="text" class="form-control" id="subject" name="subject" value="Test Email from Used Books Automation" required>
          </div>
          <div class="form-group">
            <label for="message">Message</label>
            <textarea class="form-control" id="message" name="message" rows="4" required>This is a test email from the Used Books Automation system.</textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Test Email</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('../layouts/dashboard-footer') %>>Shop URL</span>
                <span class="badge badge-primary"><%= config.shopUrl %></span>
              </div>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <span